#set -x
set -e
set -u

set +e
platform='unknown'
unamestr=`uname`

if [[ "$unamestr" == 'Linux' ]]; then
   platform='linux'
elif [[ "$unamestr" == 'FreeBSD' ]]; then
   platform='freebsd'
elif [[ "$unamestr" == 'Darwin' ]]; then
   platform='osx'
fi

if [[ "$platform" == 'osx' ]]; then
  #DETECT OSX VERSION
  OSX_VERSION_CHECK=`sw_vers | grep ProductVersion | cut -f 2 -d ':'  | egrep '10\.8|10\.9'`

  if [ $? != 0 ]; then
      echo 'You must be on Mountain Lion or greater!'
      exit 1
  fi
  set -e

  if [ ! -f /usr/bin/gcc ]; then
    printf "%s\n" $'
  You need to have Xcode with Command Line Tools installed before you can
  continue.

    1. Go to the App Store and install Xcode.
    2. Open Terminal.app
    3. Type `xcode-select --install`
    exit 1
    '
  fi

  # show the banner and wait for a response
  printf "%s" $'\e[1;32m
   _____       _ _       
  |  __ \     (_) |      
  | |__) |__ _ _| | ___  
  |  _  // _` | | |/ _ \ 
  | | \ \ (_| | | | (_) |
  |_|  \_\__,_|_|_|\___/ 
  \e[1;31m
  \e[0m
  Hello! I\'m going to set up Railo on this machine for you. It might take me a bit
  of time before I\'m done, but you\'ll end up with the best CFML environment for your machine.
  \e[0;1m
  Ready to get started? Press any key to continue.\e[0m'
  read -n 1 -s

  # prompt for sudo access. if correct we're good to go.
  echo "

  --> For added privacy invasion I'll need your local account's password."
  sudo -p "    Password for sudo: " echo "    Sweet, thanks. I'll see you in Vegas, sucker."

  echo "
  --> Making sure /opt/railo exists and belongs to you."

  sudo mkdir -p /opt/railo
  sudo chown $USER:staff /opt/railo

  if [ ! -d /opt/railo/.git ]; then
    echo
    echo "
  --> Grabbing Latest Railo Express and arranging things. Be patient this may take a while."

    git clone https://github.com/joshuairl/railoenv.git /opt/railo
  else
    echo
    printf "%s" $'\e[31m
  Warning! Railo already appears to be installed...\e[1;31m
    \e[0;1m'
    read -p "
  Would you like to override the existing installation? (y/n)" RESP
    printf "%s" $'\e[0;0m'
    if [ "$RESP" = "n" ]; then
    
      echo "
  --> Cancelled installation."
      exit 1
    else
      echo "
  --> Removing previous Railo files at /opt/railo..."
      sudo rm -rf /opt/railo

      echo "
  --> Re-creating the /opt/railo directory and ensuring your ownership."
      sudo mkdir -p /opt/railo
      sudo chown $USER:staff /opt/railo
      echo
      echo "
  --> Grabbing Latest Railo Express and arranging things. Be patient this may take a while."

      git clone https://github.com/joshuairl/railoenv.git /opt/railo
    fi
  fi

  echo "
  --> Finalizing installation..."
  touch $HOME/.profile
  echo "source /opt/railo/env.sh" >> "$HOME/.profile"

  cd $HOME

elif [[ "$platform" -eq 'freebsd' ]]; then
  echo "FREEBSD"
elif [[ "$platform" -eq 'linux' ]]; then
  echo "LINUX"
fi

echo "
You're good to go!
Close any active terminal windows and re-open to ensure everything is properly sourced.

If you do not wish to close terminal, you may try to type 'source ~/.profile' to enable it for this session.
"